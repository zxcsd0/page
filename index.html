<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>도네이션</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        #message-container {
            background-color: #ffffff;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }
        .input-wrapper {
            width: 100%;
            box-sizing: border-box;
        }
        input[type="text"], textarea, select {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s ease;
            background-color: #ffffff;
            font-family: inherit;
            box-sizing: border-box;
        }
        input[type="text"]:focus, textarea:focus, select:focus {
            border-color: #666666;
        }
        #message {
            height: 150px;
            resize: vertical;
            min-height: 150px;
            line-height: 1.5;
        }
        .button-container {
            width: 100%;
            margin-top: 10px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-sizing: border-box;
            border: none;
        }
        button.default {
            background-color: #333333;
            color: white;
        }
        button.default:hover {
            background-color: #000000;
        }
        button.success, button.error {
            cursor: default;
            pointer-events: none;
        }
        button.success {
            background-color: #ffffff;
            color: #333333;
            border: none;
            box-shadow: 0 0 0 2px #e8e8e8;
            font-weight: 500;
        }
        button.error {
            background-color: #ff5555;
            color: white;
            box-shadow: 0 2px 8px rgba(255, 85, 85, 0.3);
        }
        label {
            font-size: 14px;
            color: #666666;
            margin-bottom: -10px;
            margin-left: 5px;
        }
        .time-inputs {
            display: none;
        }
        .time-group {
            display: flex;
            gap: 20px;
        }
        .time-field {
            flex: 1;
            max-width: calc(50% - 10px);
        }
        .time-field input[type="text"] {
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="message-container">
        <div class="input-group">
            <label for="nickname">닉네임</label>
            <div class="input-wrapper">
                <input type="text" id="nickname" placeholder="닉네임">
            </div>
            <label for="message">메시지</label>
            <div class="input-wrapper">
                <textarea id="message" placeholder="메시지"></textarea>
            </div>
            <div class="time-inputs" id="timeInputs">
                <div class="time-group">
                    <div class="time-field">
                        <div class="input-wrapper">
                            <input type="text" id="startTime" placeholder="시작 시간">
                        </div>
                    </div>
                    <div class="time-field">
                        <div class="input-wrapper">
                            <input type="text" id="endTime" placeholder="끝 시간">
                        </div>
                    </div>
                </div>
            </div>
            <label for="voice-select">목소리 선택</label>
            <div class="input-wrapper">
                <select id="voice-select">
                    <option value="HuTao">목소리 1</option>
                    <option value="Furina">목소리 2</option>
                    <option value="RaidenShogun">목소리 3</option>
                    <option value="Alya">목소리 4</option>
                    <option value="Ganyu">목소리 5</option>
                    <option value="KamisatoAyaka">목소리 6</option>
                    <option value="YaeMiko">목소리 7</option>
                    <option value="ShikanokoNoko">목소리 8</option>
                    <option value="SatoruGojo">목소리 9</option>
                    <option value="DonaldTrump">목소리 10</option>
                </select>
            </div>
        </div>
        <div class="button-container">
            <button id="send-button" class="default" onclick="sendMessage()">전송</button>
        </div>
    </div>

    <script>
        let ws;
        let buttonTimeout;
        connectWebSocket();

        function updateButton(type, message) {
            const button = document.getElementById('send-button');
            const originalText = button.textContent;
            const originalClass = button.className;
            
            // Clear any existing timeout
            if (buttonTimeout) {
                clearTimeout(buttonTimeout);
            }
            
            // Update button style and text
            button.textContent = message;
            button.className = type;
            button.disabled = true;
            
            // Reset button after delay
            buttonTimeout = setTimeout(() => {
                button.textContent = '전송';
                button.className = 'default';
                button.disabled = false;
            }, 2000);
        }

        function connectWebSocket() {
            ws = new WebSocket(`ws://218.39.116.63:8765`);
            
            ws.onopen = () => {
                console.log('WebSocket 연결이 설정되었습니다.');
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.error) {
                        updateButton('error', data.error);
                    }
                } catch (error) {
                    console.error('메시지 파싱 오류:', error);
                }
            };
            
            ws.onclose = () => {
                console.log('서버와의 연결이 종료되었어요.');
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket 오류:', error);
                updateButton('error', '서버 연결 오류가 발생했어요.');
            };
        }

        async function sendMessage() {
            const button = document.getElementById('send-button');
            if (button.disabled || !button.classList.contains('default')) {
                return;
            }
            const nicknameInput = document.getElementById('nickname');
            const messageInput = document.getElementById('message');
            const voiceSelect = document.getElementById('voice-select');
            const startTimeInput = document.getElementById('startTime');
            const endTimeInput = document.getElementById('endTime');
            
            const nickname = nicknameInput.value.trim();
            const message = messageInput.value.trim();
            const selectedVoice = voiceSelect.value;
            
            if (!nickname || !message) {
                updateButton('error', '닉네임과 메시지를 모두 입력해주세요.');
                return;
            }

            let youtubeData = null;
            const youtubeLink = extractYoutubeLink(message);
            
            if (youtubeLink) {
                const embedCheck = await checkYouTubeEmbedAvailability(youtubeLink.videoId);
                
                if (!embedCheck.embeddable) {
                    updateButton('error', '재생할 수 없는 영상이에요.');
                    return;
                }

                try {
                    const startTime = startTimeInput.value.trim();
                    const endTime = endTimeInput.value.trim();
                    
                    const startSeconds = parseTimeToSeconds(startTime);
                    const endSeconds = endTime ? parseTimeToSeconds(endTime) : null;
                    
                    if (endSeconds !== null) {
                        if (startSeconds >= endSeconds) {
                            updateButton('error', '끝 시간은 시작 시간보다 커야 해요.');
                            return;
                        }
                        if (endSeconds > 86400) {
                            updateButton('error', '끝 시간은 24시간을 넘을 수 없어요.');
                            return;
                        }
                    }
                    
                    youtubeData = {
                        videoId: youtubeLink.videoId,
                        startTime: startSeconds ? startSeconds : 0,
                        endTime: endSeconds ? endSeconds : null
                    };
                } catch (error) {
                    updateButton('error', error.message);
                    return;
                }
            }

            if (ws && ws.readyState === WebSocket.OPEN) {
                const messageData = {
                    nickname: nickname,
                    message: message,
                    voice: selectedVoice,
                    youtube: youtubeData // null이 아닐 때만 포함됨
                };
                
                ws.send(JSON.stringify(messageData));
                updateButton('success', '메시지를 보냈어요.');
                messageInput.value = '';
                startTimeInput.value = '';
                endTimeInput.value = '';
                document.getElementById('timeInputs').style.display = 'none';
            } else {
                updateButton('error', '서버에 연결할 수 없어요.');
            }
        }

        function parseTimeToSeconds(timeStr) {
            if (!timeStr) return 0;
            
            timeStr = timeStr.trim();
            
            // 숫자만 있는 경우 (초)
            if (/^\d+$/.test(timeStr)) {
                return parseInt(timeStr);
            }
            
            // 분:초 형식 확인
            const timeMatch = timeStr.match(/^(\d+):(\d+)$/);
            if (timeMatch) {
                const minutes = parseInt(timeMatch[1]);
                const seconds = parseInt(timeMatch[2]);
                
                if (seconds >= 60) {
                    updateButton('error', '초는 59를 넘을 수 없어요.');
                    return
                }
                
                return minutes * 60 + seconds;
            }
            
            update('error', '올바른 시간 형식이 아니에요.');
            return;
        }

        function validateTimeInput(input) {
            const value = input.value.trim();
            if (!value) return true;

            if (/^\d+$/.test(value)) return true;

            const timeMatch = value.match(/^(\d+):(\d{0,2})$/);
            if (timeMatch) {
                if (timeMatch[2].length === 0) return true;
                const seconds = parseInt(timeMatch[2]);
                return seconds < 60;
            }

            return false;
        }

        document.getElementById('startTime').addEventListener('input', function(e) {
            if (!validateTimeInput(this)) {
                this.style.borderColor = '#ff5555';
            } else {
                this.style.borderColor = '#e0e0e0';
            }
        });

        document.getElementById('endTime').addEventListener('input', function(e) {
            if (!validateTimeInput(this)) {
                this.style.borderColor = '#ff5555';
            } else {
                this.style.borderColor = '#e0e0e0';
            }
        });


        document.getElementById('message').addEventListener('input', function(e) {
            const message = e.target.value;
            const youtubeLink = extractYoutubeLink(message);
            const timeInputs = document.getElementById('timeInputs');
            
            if (youtubeLink) {
                timeInputs.style.display = 'block';
            } else {
                timeInputs.style.display = 'none';
            }
        });

        
        document.getElementById('message').addEventListener('keydown', async (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                await sendMessage();
            }
        });
        function extractYoutubeLink(text) {
            const patterns = [
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})/,
                /(?:https?:\/\/)?(?:www\.)?youtu\.be\/([a-zA-Z0-9_-]{11})/,
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/,
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/shorts\/([a-zA-Z0-9_-]{11})/
            ];
        
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match && match[1]) {
                    return {
                        fullUrl: match[0],
                        videoId: match[1]
                    };
                }
            }
        
            return null;
        }

        async function checkYouTubeEmbedAvailability(videoId) {
            try {
                const response = await fetch(`https://www.youtube.com/oembed?url=http://www.youtube.com/watch?v=${videoId}&format=json`);
                const data = await response.json();
                
                return {
                    embeddable: response.ok && data && data.title,
                    title: data?.title
                };
            } catch (error) {
                console.error('YouTube 영상 확인 오류:', error);
                return {
                    embeddable: false,
                    error: '영상을 확인할 수 없어요.'
                };
            }
        }

    </script>
</body>
</html>